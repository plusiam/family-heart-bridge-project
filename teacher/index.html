<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ êµì‚¬ ëŒ€ì‹œë³´ë“œ - ë§ˆìŒìœ¼ë¡œ ì‡ëŠ” ìš°ë¦¬ ê°€ì¡±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .title-font {
            font-family: 'Jua', sans-serif;
        }
        
        .dropzone {
            transition: all 0.3s ease;
        }
        
        .dropzone.dragover {
            background: rgba(147, 51, 234, 0.1);
            border-color: #9333ea;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .tab-btn {
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #9333ea;
            color: white;
        }
        
        .student-row:hover {
            background: #f9fafb;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.5s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6 max-w-7xl">
        <!-- í—¤ë” -->
        <header class="bg-white rounded-lg shadow-lg p-6 mb-6 animate-slide-in">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="title-font text-3xl font-bold text-gray-800">ğŸ“Š í•™ê¸‰ ê°ì •êµìœ¡ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
                    <p class="text-gray-600 mt-2">í•™ìƒë“¤ì˜ ê°ì • í•™ìŠµ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
                </div>
                <button onclick="window.location.href='../'" class="px-4 py-2 bg-purple-500 text-white rounded-full hover:bg-purple-600 transition">
                    ğŸ  í•™ìƒ ëª¨ë“œë¡œ
                </button>
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="stat-card bg-purple-100 px-4 py-3 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-600 text-sm">í•™ê¸‰</p>
                            <p class="text-purple-800 font-bold text-lg" id="className">-</p>
                        </div>
                        <span class="text-2xl">ğŸ«</span>
                    </div>
                </div>
                <div class="stat-card bg-blue-100 px-4 py-3 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-600 text-sm">í•™ìƒ ìˆ˜</p>
                            <p class="text-blue-800 font-bold text-lg"><span id="studentCount">0</span>ëª…</p>
                        </div>
                        <span class="text-2xl">ğŸ‘¥</span>
                    </div>
                </div>
                <div class="stat-card bg-green-100 px-4 py-3 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-600 text-sm">í‰ê·  ì§„ë„</p>
                            <p class="text-green-800 font-bold text-lg"><span id="avgProgress">0</span>%</p>
                        </div>
                        <span class="text-2xl">ğŸ“ˆ</span>
                    </div>
                </div>
                <div class="stat-card bg-yellow-100 px-4 py-3 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-600 text-sm">í‰ê·  í¬ì¸íŠ¸</p>
                            <p class="text-yellow-800 font-bold text-lg"><span id="avgPoints">0</span>ì </p>
                        </div>
                        <span class="text-2xl">ğŸ†</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">ğŸ“ í•™ìƒ ë°ì´í„° ì—…ë¡œë“œ</h2>
            <div class="dropzone border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-500 transition cursor-pointer" 
                 id="dropzone"
                 ondrop="handleDrop(event)"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="mt-2 text-sm text-gray-600">
                    í•™ìƒë“¤ì˜ JSON íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”
                </p>
                <p class="text-xs text-gray-500 mt-1">
                    (ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì—…ë¡œë“œ ê°€ëŠ¥)
                </p>
                <input type="file" id="fileInput" class="hidden" multiple accept=".json" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('fileInput').click()" 
                        class="mt-4 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition">
                    íŒŒì¼ ì„ íƒ
                </button>
            </div>
            <div id="uploadedFiles" class="mt-4 space-y-2"></div>
        </div>

        <!-- ë¶„ì„ íƒ­ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6" id="analysisSection" style="display: none;">
            <div class="flex gap-2 mb-6 overflow-x-auto">
                <button class="tab-btn px-4 py-2 bg-purple-500 text-white rounded-lg whitespace-nowrap" onclick="showAnalysisTab('overview')">
                    ğŸ“Š ì „ì²´ í˜„í™©
                </button>
                <button class="tab-btn px-4 py-2 bg-gray-200 rounded-lg whitespace-nowrap" onclick="showAnalysisTab('emotions')">
                    ğŸ­ ê°ì • íŒ¨í„´
                </button>
                <button class="tab-btn px-4 py-2 bg-gray-200 rounded-lg whitespace-nowrap" onclick="showAnalysisTab('individual')">
                    ğŸ‘¤ ê°œì¸ë³„ ë¶„ì„
                </button>
                <button class="tab-btn px-4 py-2 bg-gray-200 rounded-lg whitespace-nowrap" onclick="showAnalysisTab('timeline')">
                    ğŸ“… ì‹œê°„ë³„ ì¶”ì´
                </button>
                <button class="tab-btn px-4 py-2 bg-gray-200 rounded-lg whitespace-nowrap" onclick="showAnalysisTab('recommendations')">
                    ğŸ’¡ ì¶”ì²œ í™œë™
                </button>
            </div>

            <!-- ì „ì²´ í˜„í™© íƒ­ -->
            <div id="overviewTab" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-3">ğŸ“Š ì¹´ë“œ ìˆ˜ì§‘ í˜„í™©</h3>
                        <div class="chart-container">
                            <canvas id="collectionChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-3">ğŸ¯ ê°ì • ì¹´í…Œê³ ë¦¬ ë¶„í¬</h3>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-3">ğŸ“ˆ í•™ìŠµ ì§„ë„ ë¶„í¬</h3>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-3">â­ í™œë™ í¬ì¸íŠ¸ ë¶„í¬</h3>
                        <div class="chart-container">
                            <canvas id="pointsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ê°ì • íŒ¨í„´ íƒ­ -->
            <div id="emotionsTab" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-3">ğŸŒˆ ê°ì • ì¹´í…Œê³ ë¦¬ë³„ ìˆ˜ì§‘ë¥ </h3>
                        <div class="chart-container">
                            <canvas id="emotionRadarChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-bold mb-3">ğŸ’« ì¸ê¸° ê°ì • ì¹´ë“œ Top 10</h3>
                        <div id="popularCardsContainer" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- ê°œì¸ë³„ ë¶„ì„ íƒ­ -->
            <div id="individualTab" class="tab-content hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-4 py-2 text-left">ì´ë¦„</th>
                                <th class="px-4 py-2 text-center">ì•„ë°”íƒ€</th>
                                <th class="px-4 py-2 text-center">ìˆ˜ì§‘ ì¹´ë“œ</th>
                                <th class="px-4 py-2 text-center">ì œì‘ ì¹´ë“œ</th>
                                <th class="px-4 py-2 text-center">í¬ì¸íŠ¸</th>
                                <th class="px-4 py-2 text-center">ì§„ë„ìœ¨</th>
                                <th class="px-4 py-2 text-center">ì£¼ìš” ê°ì •</th>
                                <th class="px-4 py-2 text-center">ì¶”ì²œ í™œë™</th>
                            </tr>
                        </thead>
                        <tbody id="studentTable">
                            <!-- ë™ì  ìƒì„± -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ì‹œê°„ë³„ ì¶”ì´ íƒ­ -->
            <div id="timelineTab" class="tab-content hidden">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-3">ğŸ“… ì¼ë³„ í™œë™ ì¶”ì´</h3>
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ì¶”ì²œ í™œë™ íƒ­ -->
            <div id="recommendationsTab" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <h3 class="font-bold mb-3 text-blue-800">ğŸ¯ í•™ê¸‰ ì „ì²´ ì¶”ì²œ</h3>
                        <ul id="classRecommendations" class="space-y-2 text-gray-700">
                            <!-- ë™ì  ìƒì„± -->
                        </ul>
                    </div>
                    <div class="bg-green-50 p-6 rounded-lg">
                        <h3 class="font-bold mb-3 text-green-800">ğŸ‘¥ ê°œë³„ ë§ì¶¤ ì¶”ì²œ</h3>
                        <div id="individualRecommendations" class="space-y-3">
                            <!-- ë™ì  ìƒì„± -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¦¬í¬íŠ¸ ìƒì„± -->
        <div class="mt-6 flex justify-center gap-4" id="reportButtons" style="display: none;">
            <button onclick="generatePDFReport()" 
                class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                PDF ë¦¬í¬íŠ¸ ìƒì„±
            </button>
            <button onclick="exportToExcel()" 
                class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v1a1 1 0 001 1h4a1 1 0 001-1v-1m-5 0h5m-5 0l1-12h3l1 12m-5 0H5m10 0h4M7 5h10"></path>
                </svg>
                Excel ë‚´ë³´ë‚´ê¸°
            </button>
            <button onclick="window.print()" 
                class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                </svg>
                ì¸ì‡„í•˜ê¸°
            </button>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let students = [];
        let className = '';
        let charts = {};

        // ê°ì • ì¹´ë“œ ë°ì´í„° (í•™ìƒ ë„êµ¬ì™€ ë™ì¼)
        const emotionCards = [
            { id: 1, name: 'ê¸°ì¨', emoji: 'ğŸ˜Š', category: 'happy', color: '#FFD93D' },
            { id: 2, name: 'ì‹ ë‚¨', emoji: 'ğŸ¤—', category: 'happy', color: '#FFD93D' },
            { id: 3, name: 'ë§Œì¡±', emoji: 'ğŸ˜Œ', category: 'happy', color: '#FFD93D' },
            { id: 4, name: 'ìë‘ìŠ¤ëŸ¬ì›€', emoji: 'ğŸ˜', category: 'happy', color: '#FFD93D' },
            { id: 5, name: 'ê°ì‚¬', emoji: 'ğŸ™', category: 'happy', color: '#FFD93D' },
            { id: 6, name: 'ìŠ¬í””', emoji: 'ğŸ˜¢', category: 'sad', color: '#4682B4' },
            { id: 7, name: 'ì™¸ë¡œì›€', emoji: 'ğŸ˜”', category: 'sad', color: '#4682B4' },
            { id: 8, name: 'ì‹¤ë§', emoji: 'ğŸ˜', category: 'sad', color: '#4682B4' },
            { id: 9, name: 'ê·¸ë¦¬ì›€', emoji: 'ğŸ¥º', category: 'sad', color: '#4682B4' },
            { id: 10, name: 'í›„íšŒ', emoji: 'ğŸ˜“', category: 'sad', color: '#4682B4' },
            { id: 11, name: 'í™”ë‚¨', emoji: 'ğŸ˜ ', category: 'angry', color: '#FF6B6B' },
            { id: 12, name: 'ì§œì¦', emoji: 'ğŸ˜¤', category: 'angry', color: '#FF6B6B' },
            { id: 13, name: 'ë‹µë‹µí•¨', emoji: 'ğŸ˜£', category: 'angry', color: '#FF6B6B' },
            { id: 14, name: 'ì–µìš¸í•¨', emoji: 'ğŸ˜–', category: 'angry', color: '#FF6B6B' },
            { id: 15, name: 'ë¶„ë…¸', emoji: 'ğŸ¤¬', category: 'angry', color: '#FF6B6B' },
            { id: 16, name: 'ë‘ë ¤ì›€', emoji: 'ğŸ˜¨', category: 'fear', color: '#6C5CE7' },
            { id: 17, name: 'ê±±ì •', emoji: 'ğŸ˜Ÿ', category: 'fear', color: '#6C5CE7' },
            { id: 18, name: 'ê¸´ì¥', emoji: 'ğŸ˜°', category: 'fear', color: '#6C5CE7' },
            { id: 19, name: 'ë¶ˆì•ˆ', emoji: 'ğŸ˜¥', category: 'fear', color: '#6C5CE7' },
            { id: 20, name: 'ì´ˆì¡°í•¨', emoji: 'ğŸ˜¬', category: 'fear', color: '#6C5CE7' },
            { id: 21, name: 'ë†€ëŒ', emoji: 'ğŸ˜²', category: 'surprise', color: '#FFA502' },
            { id: 22, name: 'ì‹ ê¸°í•¨', emoji: 'ğŸ¤”', category: 'surprise', color: '#FFA502' },
            { id: 23, name: 'ë‹¹í™©', emoji: 'ğŸ˜³', category: 'surprise', color: '#FFA502' },
            { id: 24, name: 'ì¶©ê²©', emoji: 'ğŸ¤¯', category: 'surprise', color: '#FFA502' },
            { id: 25, name: 'ê°íƒ„', emoji: 'ğŸ˜', category: 'surprise', color: '#FFA502' },
            { id: 26, name: 'ì‚¬ë‘', emoji: 'ğŸ¥°', category: 'love', color: '#FD79A8' },
            { id: 27, name: 'ì„¤ë ˜', emoji: 'ğŸ’•', category: 'love', color: '#FD79A8' },
            { id: 28, name: 'ì• ì •', emoji: 'ğŸ’–', category: 'love', color: '#FD79A8' },
            { id: 29, name: 'ì¹œë°€í•¨', emoji: 'ğŸ¤', category: 'love', color: '#FD79A8' },
            { id: 30, name: 'í¬ê·¼í•¨', emoji: 'ğŸ¤—', category: 'love', color: '#FD79A8' }
        ];

        // íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropzone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropzone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropzone').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            processFiles(files);
        }

        // íŒŒì¼ ì²˜ë¦¬
        async function processFiles(files) {
            const fileList = document.getElementById('uploadedFiles');
            fileList.innerHTML = '';
            students = [];
            
            for (const file of files) {
                if (file.name.endsWith('.json')) {
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        // ìœ íš¨ì„± ê²€ì¦
                        if (data.profile && data.collections) {
                            students.push(data);
                            
                            // íŒŒì¼ ëª©ë¡ í‘œì‹œ
                            const fileItem = document.createElement('div');
                            fileItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                            fileItem.innerHTML = `
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">${data.profile.avatar || 'ğŸ¦'}</span>
                                    <div>
                                        <p class="font-medium">${data.profile.name || 'ìµëª…'}</p>
                                        <p class="text-sm text-gray-500">${file.name}</p>
                                    </div>
                                </div>
                                <span class="text-green-500">âœ“</span>
                            `;
                            fileList.appendChild(fileItem);
                        }
                    } catch (error) {
                        console.error('íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                }
            }
            
            if (students.length > 0) {
                analyzeData();
                document.getElementById('analysisSection').style.display = 'block';
                document.getElementById('reportButtons').style.display = 'flex';
            }
        }

        // ë°ì´í„° ë¶„ì„
        function analyzeData() {
            // ê¸°ë³¸ í†µê³„
            updateBasicStats();
            
            // ì°¨íŠ¸ ìƒì„±
            createCharts();
            
            // ê°œì¸ë³„ í…Œì´ë¸”
            createStudentTable();
            
            // ì¶”ì²œ ìƒì„±
            generateRecommendations();
        }

        // ê¸°ë³¸ í†µê³„ ì—…ë°ì´íŠ¸
        function updateBasicStats() {
            const studentCount = students.length;
            const avgProgress = Math.round(
                students.reduce((sum, s) => sum + (s.statistics?.completionRate || 0), 0) / studentCount
            );
            const avgPoints = Math.round(
                students.reduce((sum, s) => sum + (s.statistics?.totalPoints || 0), 0) / studentCount
            );
            
            // í•™ê¸‰ ì •ë³´ ì¶”ì¶œ
            const classes = students.map(s => s.profile?.className).filter(Boolean);
            className = classes.length > 0 ? classes[0] : '3í•™ë…„';
            
            document.getElementById('className').textContent = className;
            document.getElementById('studentCount').textContent = studentCount;
            document.getElementById('avgProgress').textContent = avgProgress;
            document.getElementById('avgPoints').textContent = avgPoints;
        }

        // ì°¨íŠ¸ ìƒì„±
        function createCharts() {
            // ì¹´ë“œ ìˆ˜ì§‘ í˜„í™© ì°¨íŠ¸
            const collectionCtx = document.getElementById('collectionChart').getContext('2d');
            charts.collection = new Chart(collectionCtx, {
                type: 'bar',
                data: {
                    labels: students.map(s => s.profile?.name || 'ìµëª…'),
                    datasets: [{
                        label: 'ìˆ˜ì§‘í•œ ì¹´ë“œ',
                        data: students.map(s => s.collections?.collectedCards?.length || 0),
                        backgroundColor: 'rgba(147, 51, 234, 0.5)',
                        borderColor: 'rgb(147, 51, 234)',
                        borderWidth: 1
                    }, {
                        label: 'ë§Œë“  ì¹´ë“œ',
                        data: students.map(s => s.collections?.customCards?.length || 0),
                        backgroundColor: 'rgba(34, 197, 94, 0.5)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // ê°ì • ì¹´í…Œê³ ë¦¬ ë¶„í¬ ì°¨íŠ¸
            const categoryData = calculateCategoryDistribution();
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            charts.category = new Chart(categoryCtx, {
                type: 'pie',
                data: {
                    labels: ['ê¸°ì¨', 'ìŠ¬í””', 'í™”ë‚¨', 'ë‘ë ¤ì›€', 'ë†€ëŒ', 'ì‚¬ë‘'],
                    datasets: [{
                        data: [
                            categoryData.happy || 0,
                            categoryData.sad || 0,
                            categoryData.angry || 0,
                            categoryData.fear || 0,
                            categoryData.surprise || 0,
                            categoryData.love || 0
                        ],
                        backgroundColor: [
                            '#FFD93D',
                            '#4682B4',
                            '#FF6B6B',
                            '#6C5CE7',
                            '#FFA502',
                            '#FD79A8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // ì§„ë„ ë¶„í¬ ì°¨íŠ¸
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            charts.progress = new Chart(progressCtx, {
                type: 'doughnut',
                data: {
                    labels: ['0-25%', '26-50%', '51-75%', '76-100%'],
                    datasets: [{
                        data: calculateProgressDistribution(),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.5)',
                            'rgba(245, 158, 11, 0.5)',
                            'rgba(59, 130, 246, 0.5)',
                            'rgba(34, 197, 94, 0.5)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // í¬ì¸íŠ¸ ë¶„í¬ ì°¨íŠ¸
            const pointsCtx = document.getElementById('pointsChart').getContext('2d');
            charts.points = new Chart(pointsCtx, {
                type: 'line',
                data: {
                    labels: students.map(s => s.profile?.name || 'ìµëª…'),
                    datasets: [{
                        label: 'íšë“ í¬ì¸íŠ¸',
                        data: students.map(s => s.statistics?.totalPoints || 0),
                        borderColor: 'rgb(251, 191, 36)',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ì¹´í…Œê³ ë¦¬ ë¶„í¬ ê³„ì‚°
        function calculateCategoryDistribution() {
            const distribution = {};
            
            students.forEach(student => {
                if (student.collections?.collectedCards) {
                    student.collections.collectedCards.forEach(cardId => {
                        const card = emotionCards.find(c => c.id === cardId);
                        if (card) {
                            distribution[card.category] = (distribution[card.category] || 0) + 1;
                        }
                    });
                }
            });
            
            return distribution;
        }

        // ì§„ë„ ë¶„í¬ ê³„ì‚°
        function calculateProgressDistribution() {
            const ranges = [0, 0, 0, 0];
            
            students.forEach(student => {
                const rate = student.statistics?.completionRate || 0;
                if (rate <= 25) ranges[0]++;
                else if (rate <= 50) ranges[1]++;
                else if (rate <= 75) ranges[2]++;
                else ranges[3]++;
            });
            
            return ranges;
        }

        // í•™ìƒ í…Œì´ë¸” ìƒì„±
        function createStudentTable() {
            const tbody = document.getElementById('studentTable');
            tbody.innerHTML = '';
            
            students.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'student-row border-b';
                
                const favoriteCategory = getFavoriteCategory(student);
                const recommendation = getRecommendation(student);
                
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${student.profile?.name || 'ìµëª…'}</td>
                    <td class="px-4 py-3 text-center text-2xl">${student.profile?.avatar || 'ğŸ¦'}</td>
                    <td class="px-4 py-3 text-center">${student.collections?.collectedCards?.length || 0}</td>
                    <td class="px-4 py-3 text-center">${student.collections?.customCards?.length || 0}</td>
                    <td class="px-4 py-3 text-center">${student.statistics?.totalPoints || 0}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center">
                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-500 h-2 rounded-full" style="width: ${student.statistics?.completionRate || 0}%"></div>
                            </div>
                            <span class="ml-2 text-sm">${student.statistics?.completionRate || 0}%</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs ${getCategoryColor(favoriteCategory)}">
                            ${getCategoryName(favoriteCategory)}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center text-sm">${recommendation}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // ì¦ê²¨ì°¾ëŠ” ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
        function getFavoriteCategory(student) {
            const categoryCount = {};
            
            if (student.collections?.collectedCards) {
                student.collections.collectedCards.forEach(cardId => {
                    const card = emotionCards.find(c => c.id === cardId);
                    if (card) {
                        categoryCount[card.category] = (categoryCount[card.category] || 0) + 1;
                    }
                });
            }
            
            let maxCategory = 'happy';
            let maxCount = 0;
            
            for (const [category, count] of Object.entries(categoryCount)) {
                if (count > maxCount) {
                    maxCount = count;
                    maxCategory = category;
                }
            }
            
            return maxCategory;
        }

        // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ
        function getCategoryColor(category) {
            const colors = {
                happy: 'bg-yellow-100 text-yellow-800',
                sad: 'bg-blue-100 text-blue-800',
                angry: 'bg-red-100 text-red-800',
                fear: 'bg-purple-100 text-purple-800',
                surprise: 'bg-orange-100 text-orange-800',
                love: 'bg-pink-100 text-pink-800'
            };
            return colors[category] || 'bg-gray-100 text-gray-800';
        }

        // ì¹´í…Œê³ ë¦¬ ì´ë¦„
        function getCategoryName(category) {
            const names = {
                happy: 'ê¸°ì¨',
                sad: 'ìŠ¬í””',
                angry: 'í™”ë‚¨',
                fear: 'ë‘ë ¤ì›€',
                surprise: 'ë†€ëŒ',
                love: 'ì‚¬ë‘'
            };
            return names[category] || 'ê¸°íƒ€';
        }

        // ì¶”ì²œ í™œë™
        function getRecommendation(student) {
            const progress = student.statistics?.completionRate || 0;
            
            if (progress < 30) {
                return 'ğŸ¯ ê°ì • ì¹´ë“œ ìˆ˜ì§‘í•˜ê¸°';
            } else if (progress < 60) {
                return 'âœï¸ ë‚˜ë§Œì˜ ì¹´ë“œ ë§Œë“¤ê¸°';
            } else if (progress < 90) {
                return 'ğŸ® ê°ì • ê²Œì„ ë„ì „';
            } else {
                return 'ğŸŒŸ ë‹¤ë¥¸ ì¹œêµ¬ ë„ì™€ì£¼ê¸°';
            }
        }

        // ì¶”ì²œ ìƒì„±
        function generateRecommendations() {
            // í•™ê¸‰ ì „ì²´ ì¶”ì²œ
            const classRec = document.getElementById('classRecommendations');
            const avgProgress = students.reduce((sum, s) => sum + (s.statistics?.completionRate || 0), 0) / students.length;
            
            classRec.innerHTML = '';
            
            if (avgProgress < 50) {
                classRec.innerHTML = `
                    <li>â€¢ ğŸ“š ê¸°ë³¸ ê°ì • ì¹´ë“œ ìˆ˜ì§‘ í™œë™ ê°•í™”</li>
                    <li>â€¢ ğŸ® ê²Œì„ì„ í†µí•œ í¥ë¯¸ ìœ ë°œ</li>
                    <li>â€¢ ğŸ‘¥ ì§ í™œë™ìœ¼ë¡œ ë™ê¸° ë¶€ì—¬</li>
                `;
            } else {
                classRec.innerHTML = `
                    <li>â€¢ âœ¨ ì°½ì˜ì ì¸ ì¹´ë“œ ì œì‘ í™œë™</li>
                    <li>â€¢ ğŸ­ ê°ì • ì—­í• ê·¹ í™œë™</li>
                    <li>â€¢ ğŸ“ ê°ì • ì¼ê¸° ì‘ì„±í•˜ê¸°</li>
                `;
            }
            
            // ê°œë³„ ì¶”ì²œ
            const individualRec = document.getElementById('individualRecommendations');
            individualRec.innerHTML = '';
            
            const lowProgress = students.filter(s => (s.statistics?.completionRate || 0) < 30);
            if (lowProgress.length > 0) {
                const div = document.createElement('div');
                div.className = 'bg-red-50 p-3 rounded-lg';
                div.innerHTML = `
                    <p class="font-medium text-red-800 mb-1">ğŸ“ ì¶”ê°€ ì§€ì› í•„ìš”</p>
                    <p class="text-sm text-gray-700">${lowProgress.map(s => s.profile?.name || 'ìµëª…').join(', ')}</p>
                `;
                individualRec.appendChild(div);
            }
            
            const highProgress = students.filter(s => (s.statistics?.completionRate || 0) >= 80);
            if (highProgress.length > 0) {
                const div = document.createElement('div');
                div.className = 'bg-blue-50 p-3 rounded-lg';
                div.innerHTML = `
                    <p class="font-medium text-blue-800 mb-1">ğŸŒŸ ë˜ë˜ ë„ìš°ë¯¸ ì¶”ì²œ</p>
                    <p class="text-sm text-gray-700">${highProgress.map(s => s.profile?.name || 'ìµëª…').join(', ')}</p>
                `;
                individualRec.appendChild(div);
            }
        }

        // íƒ­ ì „í™˜
        function showAnalysisTab(tab) {
            // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // ëª¨ë“  ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-purple-500', 'text-white');
                btn.classList.add('bg-gray-200');
            });
            
            // ì„ íƒëœ íƒ­ í‘œì‹œ
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            event.target.classList.add('active', 'bg-purple-500', 'text-white');
            event.target.classList.remove('bg-gray-200');
            
            // ì¶”ê°€ ì°¨íŠ¸ ìƒì„± (í•„ìš”ì‹œ)
            if (tab === 'emotions' && !charts.emotionRadar) {
                createEmotionRadarChart();
                createPopularCards();
            } else if (tab === 'timeline' && !charts.timeline) {
                createTimelineChart();
            }
        }

        // ê°ì • ë ˆì´ë” ì°¨íŠ¸
        function createEmotionRadarChart() {
            const ctx = document.getElementById('emotionRadarChart').getContext('2d');
            
            const categories = ['happy', 'sad', 'angry', 'fear', 'surprise', 'love'];
            const categoryNames = ['ê¸°ì¨', 'ìŠ¬í””', 'í™”ë‚¨', 'ë‘ë ¤ì›€', 'ë†€ëŒ', 'ì‚¬ë‘'];
            
            // ê° ì¹´í…Œê³ ë¦¬ë³„ í‰ê·  ìˆ˜ì§‘ë¥  ê³„ì‚°
            const avgData = categories.map(category => {
                const categoryCards = emotionCards.filter(c => c.category === category);
                let totalCollected = 0;
                
                students.forEach(student => {
                    if (student.collections?.collectedCards) {
                        const collected = categoryCards.filter(card => 
                            student.collections.collectedCards.includes(card.id)
                        ).length;
                        totalCollected += (collected / categoryCards.length) * 100;
                    }
                });
                
                return Math.round(totalCollected / students.length);
            });
            
            charts.emotionRadar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: categoryNames,
                    datasets: [{
                        label: 'í‰ê·  ìˆ˜ì§‘ë¥  (%)',
                        data: avgData,
                        borderColor: 'rgb(147, 51, 234)',
                        backgroundColor: 'rgba(147, 51, 234, 0.2)',
                        pointBackgroundColor: 'rgb(147, 51, 234)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(147, 51, 234)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // ì¸ê¸° ì¹´ë“œ í‘œì‹œ
        function createPopularCards() {
            const container = document.getElementById('popularCardsContainer');
            const cardCount = {};
            
            students.forEach(student => {
                if (student.collections?.collectedCards) {
                    student.collections.collectedCards.forEach(cardId => {
                        cardCount[cardId] = (cardCount[cardId] || 0) + 1;
                    });
                }
            });
            
            const sortedCards = Object.entries(cardCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            container.innerHTML = sortedCards.map(([cardId, count]) => {
                const card = emotionCards.find(c => c.id === parseInt(cardId));
                if (!card) return '';
                
                return `
                    <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${card.emoji}</span>
                            <span class="font-medium">${card.name}</span>
                        </div>
                        <span class="text-sm text-gray-500">${count}ëª…</span>
                    </div>
                `;
            }).join('');
        }

        // íƒ€ì„ë¼ì¸ ì°¨íŠ¸
        function createTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            // ë‚ ì§œë³„ í™œë™ ì§‘ê³„
            const dailyActivity = {};
            
            students.forEach(student => {
                if (student.timeline) {
                    student.timeline.forEach(day => {
                        const date = day.date;
                        if (!dailyActivity[date]) {
                            dailyActivity[date] = 0;
                        }
                        dailyActivity[date] += day.activities?.length || 0;
                    });
                }
            });
            
            const sortedDates = Object.keys(dailyActivity).sort();
            
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(d => new Date(d).toLocaleDateString('ko-KR')),
                    datasets: [{
                        label: 'ì¼ë³„ í™œë™ ìˆ˜',
                        data: sortedDates.map(d => dailyActivity[d]),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // PDF ë¦¬í¬íŠ¸ ìƒì„±
        function generatePDFReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // í°íŠ¸ ì„¤ì • (í•œê¸€ ì§€ì›ì„ ìœ„í•´)
            doc.setFont('helvetica');
            
            // ì œëª©
            doc.setFontSize(20);
            doc.text('Class Emotion Education Report', 105, 20, { align: 'center' });
            
            // ê¸°ë³¸ ì •ë³´
            doc.setFontSize(12);
            doc.text(`Class: ${className}`, 20, 40);
            doc.text(`Date: ${new Date().toLocaleDateString('ko-KR')}`, 20, 50);
            doc.text(`Total Students: ${students.length}`, 20, 60);
            
            // í†µê³„ í…Œì´ë¸”
            const avgProgress = Math.round(
                students.reduce((sum, s) => sum + (s.statistics?.completionRate || 0), 0) / students.length
            );
            const avgPoints = Math.round(
                students.reduce((sum, s) => sum + (s.statistics?.totalPoints || 0), 0) / students.length
            );
            
            const stats = [
                ['Item', 'Average', 'Max', 'Min'],
                ['Collected Cards', 
                 Math.round(students.reduce((sum, s) => sum + (s.collections?.collectedCards?.length || 0), 0) / students.length),
                 Math.max(...students.map(s => s.collections?.collectedCards?.length || 0)),
                 Math.min(...students.map(s => s.collections?.collectedCards?.length || 0))
                ],
                ['Points', avgPoints,
                 Math.max(...students.map(s => s.statistics?.totalPoints || 0)),
                 Math.min(...students.map(s => s.statistics?.totalPoints || 0))
                ],
                ['Progress (%)', avgProgress,
                 Math.max(...students.map(s => s.statistics?.completionRate || 0)),
                 Math.min(...students.map(s => s.statistics?.completionRate || 0))
                ]
            ];
            
            doc.autoTable({
                head: [stats[0]],
                body: stats.slice(1),
                startY: 80
            });
            
            // ê°œì¸ë³„ ì •ë³´
            doc.addPage();
            doc.setFontSize(16);
            doc.text('Individual Student Analysis', 20, 20);
            
            const studentData = students.map(s => [
                s.profile?.name || 'Anonymous',
                s.collections?.collectedCards?.length || 0,
                s.collections?.customCards?.length || 0,
                s.statistics?.totalPoints || 0,
                `${s.statistics?.completionRate || 0}%`
            ]);
            
            doc.autoTable({
                head: [['Name', 'Collected', 'Created', 'Points', 'Progress']],
                body: studentData,
                startY: 30
            });
            
            // ì €ì¥
            doc.save(`Class_Report_${className}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Excel ë‚´ë³´ë‚´ê¸°
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // í•™ìƒ ë°ì´í„° ì‹œíŠ¸
            const studentData = students.map(s => ({
                'ì´ë¦„': s.profile?.name || 'ìµëª…',
                'í•™ê¸‰': s.profile?.className || '',
                'ì•„ë°”íƒ€': s.profile?.avatar || '',
                'ìˆ˜ì§‘í•œ ì¹´ë“œ': s.collections?.collectedCards?.length || 0,
                'ë§Œë“  ì¹´ë“œ': s.collections?.customCards?.length || 0,
                'í¬ì¸íŠ¸': s.statistics?.totalPoints || 0,
                'ì§„ë„ìœ¨(%)': s.statistics?.completionRate || 0,
                'ì£¼ìš” ê°ì •': getCategoryName(getFavoriteCategory(s))
            }));
            
            const ws = XLSX.utils.json_to_sheet(studentData);
            XLSX.utils.book_append_sheet(wb, ws, 'í•™ìƒ ë¶„ì„');
            
            // í†µê³„ ì‹œíŠ¸
            const statsData = [{
                'í•­ëª©': 'í•™ìƒ ìˆ˜',
                'ê°’': students.length
            }, {
                'í•­ëª©': 'í‰ê·  ì§„ë„ìœ¨',
                'ê°’': Math.round(students.reduce((sum, s) => sum + (s.statistics?.completionRate || 0), 0) / students.length) + '%'
            }, {
                'í•­ëª©': 'í‰ê·  í¬ì¸íŠ¸',
                'ê°’': Math.round(students.reduce((sum, s) => sum + (s.statistics?.totalPoints || 0), 0) / students.length)
            }];
            
            const ws2 = XLSX.utils.json_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, ws2, 'í†µê³„');
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(wb, `í•™ê¸‰ë¶„ì„_${className}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ë“œë¡­ì¡´ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('dropzone').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
        });
    </script>
</body>
</html>